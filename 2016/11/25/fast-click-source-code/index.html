<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="最近H5 APP开发过程中，遇到各种许多问题，诸如点击无效，checkbox无法选中，点击穿透等问题。一切罪责最终都指向了fastclick，于是决定要翻开其源码see see ，否则一些问题真如盲人摸象一般。其实fastclick的代码还是蛮简单的，不多，就800多行，其中大部分代码都是在做一些Hack类的工作，主要用于判定各种类型的设备或者浏览器特性，而最终的核心代码也就是百来行吧。其实Fas">
<meta name="keywords" content="前端, javaScript, github">
<meta property="og:type" content="article">
<meta property="og:title" content="FastClick.js源码解读">
<meta property="og:url" content="http://yoursite.com/2016/11/25/fast-click-source-code/index.html">
<meta property="og:site_name" content="何必云梯">
<meta property="og:description" content="最近H5 APP开发过程中，遇到各种许多问题，诸如点击无效，checkbox无法选中，点击穿透等问题。一切罪责最终都指向了fastclick，于是决定要翻开其源码see see ，否则一些问题真如盲人摸象一般。其实fastclick的代码还是蛮简单的，不多，就800多行，其中大部分代码都是在做一些Hack类的工作，主要用于判定各种类型的设备或者浏览器特性，而最终的核心代码也就是百来行吧。其实Fas">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-06-02T03:14:46.804Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FastClick.js源码解读">
<meta name="twitter:description" content="最近H5 APP开发过程中，遇到各种许多问题，诸如点击无效，checkbox无法选中，点击穿透等问题。一切罪责最终都指向了fastclick，于是决定要翻开其源码see see ，否则一些问题真如盲人摸象一般。其实fastclick的代码还是蛮简单的，不多，就800多行，其中大部分代码都是在做一些Hack类的工作，主要用于判定各种类型的设备或者浏览器特性，而最终的核心代码也就是百来行吧。其实Fas">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/11/25/fast-click-source-code/">





  <title>FastClick.js源码解读 | 何必云梯</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">何必云梯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">站在巨人的肩膀上</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/25/fast-click-source-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="何必云梯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">FastClick.js源码解读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-25T16:50:07+08:00">
                2016-11-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近H5 APP开发过程中，遇到各种许多问题，诸如点击无效，checkbox无法选中，点击穿透等问题。<br>一切罪责最终都指向了fastclick，于是决定要翻开其源码see see ，否则一些问题真如盲人摸象一般。<br>其实fastclick的代码还是蛮简单的，不多，就800多行，其中大部分代码都是在做一些Hack类的工作，主要用于判定各种类型的设备或者浏览器特性，而最终的核心代码也就是百来行吧。<br>其实Fastclick具体就做了以下几件事情：<br>1 采用touch事件替代click事件。<br>2 替换click默认事件延迟300毫秒为200毫秒。<br>3 修改正了一些IOS与android所存在兼容问题。</p>
<p>首先翻开代码入口，也就是构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">FastClick</span><span class="params">(layer, options)</span> </span>&#123;</span><br><span class="line">	<span class="string">'use strict'</span>;</span><br><span class="line">	<span class="keyword">var</span> oldOnClick;</span><br><span class="line"></span><br><span class="line">	options = options || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Whether a click is currently being tracked.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> boolean</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.trackingClick = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Timestamp for when click tracking started.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.trackingClickStart = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The element being tracked for a click.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> EventTarget</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.targetElement = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * X-coordinate of touch start event.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.touchStartX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Y-coordinate of touch start event.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.touchStartY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ID of the last touch, retrieved from Touch.identifier.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.lastTouchIdentifier = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Touchmove boundary, beyond which a click will be cancelled.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.touchBoundary = options.touchBoundary || <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The FastClick layer.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> Element</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.layer = layer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The minimum time between tap(touchstart and touchend) events</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@type</span> number</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">this</span>.tapDelay = options.tapDelay || <span class="number">200</span>;<span class="comment">//修改延迟时间为200ms</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FastClick.notNeeded(layer)) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Some old versions of Android don't have Function.prototype.bind</span></span><br><span class="line">	<span class="function">function <span class="title">bind</span><span class="params">(method, context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> function() &#123; <span class="keyword">return</span> method.apply(context, arguments); &#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> methods = [<span class="string">'onMouse'</span>, <span class="string">'onClick'</span>, <span class="string">'onTouchStart'</span>, <span class="string">'onTouchMove'</span>, <span class="string">'onTouchEnd'</span>, <span class="string">'onTouchCancel'</span>];</span><br><span class="line">	<span class="keyword">var</span> context = <span class="keyword">this</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = methods.length; i &lt; l; i++) &#123;</span><br><span class="line">		context[methods[i]] = bind(context[methods[i]], context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set up event handlers as required</span></span><br><span class="line">	<span class="keyword">if</span> (deviceIsAndroid) &#123;</span><br><span class="line">		layer.addEventListener(<span class="string">'mouseover'</span>, <span class="keyword">this</span>.onMouse, <span class="keyword">true</span>);</span><br><span class="line">		layer.addEventListener(<span class="string">'mousedown'</span>, <span class="keyword">this</span>.onMouse, <span class="keyword">true</span>);</span><br><span class="line">		layer.addEventListener(<span class="string">'mouseup'</span>, <span class="keyword">this</span>.onMouse, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	layer.addEventListener(<span class="string">'click'</span>, <span class="keyword">this</span>.onClick, <span class="keyword">true</span>);</span><br><span class="line">	layer.addEventListener(<span class="string">'touchstart'</span>, <span class="keyword">this</span>.onTouchStart, <span class="keyword">false</span>);</span><br><span class="line">	layer.addEventListener(<span class="string">'touchmove'</span>, <span class="keyword">this</span>.onTouchMove, <span class="keyword">false</span>);</span><br><span class="line">	layer.addEventListener(<span class="string">'touchend'</span>, <span class="keyword">this</span>.onTouchEnd, <span class="keyword">false</span>);</span><br><span class="line">	layer.addEventListener(<span class="string">'touchcancel'</span>, <span class="keyword">this</span>.onTouchCancel, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Hack is required for browsers that don't support Event#stopImmediatePropagation (e.g. Android 2)</span></span><br><span class="line">	<span class="comment">// which is how FastClick normally stops click events bubbling to callbacks registered on the FastClick</span></span><br><span class="line">	<span class="comment">// layer when they are cancelled.</span></span><br><span class="line">	<span class="keyword">if</span> (!Event.prototype.stopImmediatePropagation) &#123;</span><br><span class="line">		layer.removeEventListener = function(type, callback, capture) &#123;</span><br><span class="line">			<span class="keyword">var</span> rmv = Node.prototype.removeEventListener;</span><br><span class="line">			<span class="keyword">if</span> (type === <span class="string">'click'</span>) &#123;</span><br><span class="line">				rmv.call(layer, type, callback.hijacked || callback, capture);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				rmv.call(layer, type, callback, capture);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		layer.addEventListener = function(type, callback, capture) &#123;</span><br><span class="line">			<span class="keyword">var</span> adv = Node.prototype.addEventListener;</span><br><span class="line">			<span class="keyword">if</span> (type === <span class="string">'click'</span>) &#123;</span><br><span class="line">				adv.call(layer, type, callback.hijacked || (callback.hijacked = function(event) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!event.propagationStopped) &#123;</span><br><span class="line">						callback(event);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;), capture);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				adv.call(layer, type, callback, capture);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If a handler is already declared in the element's onclick attribute, it will be fired before</span></span><br><span class="line">	<span class="comment">// FastClick's onClick handler. Fix this by pulling out the user-defined handler function and</span></span><br><span class="line">	<span class="comment">// adding it as listener.</span></span><br><span class="line">	<span class="keyword">if</span> (typeof layer.onclick === <span class="string">'function'</span>) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Android browser on at least 3.2 requires a new reference to the function in layer.onclick</span></span><br><span class="line">		<span class="comment">// - the old one won't work if passed to addEventListener directly.</span></span><br><span class="line">		oldOnClick = layer.onclick;</span><br><span class="line">		layer.addEventListener(<span class="string">'click'</span>, function(event) &#123;</span><br><span class="line">			oldOnClick(event);</span><br><span class="line">		&#125;, <span class="keyword">false</span>);</span><br><span class="line">		layer.onclick = <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码主要做了两件事：<br>1 定义了一堆的初始化变量；<br>2 监听了一堆的事件（根据android和ios分别监听）；<br>当然还包括一些细节的设定，如：判定stopImmediatePropagation属性是否存在，是否存在 onclick的写法等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Android requires exceptions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> deviceIsAndroid = navigator.userAgent.indexOf(<span class="string">'Android'</span>) &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * iOS requires exceptions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> deviceIsIOS = <span class="regexp">/iP(ad|hone|od)/</span>.test(navigator.userAgent);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * iOS 4 requires an exception for select elements.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> deviceIsIOS4 = deviceIsIOS &amp;&amp; (<span class="regexp">/OS 4_\d(_\d)?/</span>).test(navigator.userAgent);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * iOS 6.0(+?) requires the target element to be manually derived</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> deviceIsIOSWithBadTarget = deviceIsIOS &amp;&amp; (<span class="regexp">/OS ([6-9]|\d&#123;2&#125;)_\d/</span>).test(navigator.userAgent);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BlackBerry requires exceptions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @type boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> deviceIsBlackBerry10 = navigator.userAgent.indexOf(<span class="string">'BB10'</span>) &gt; <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>再往下走，就是一些基础变量的定义，主要包括设备的检测。</p>
<p>接下来就是一些回调方法的定义：</p>
<h3 id="needsClick-方法"><a href="#needsClick-方法" class="headerlink" title="needsClick 方法"></a>needsClick 方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine whether a given element requires a native click.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;EventTarget|Element&#125; target Target DOM element</span></span><br><span class="line"><span class="comment"> * @returns &#123;boolean&#125; Returns true if the element needs a native click</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FastClick.prototype.needsClick = <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line"><span class="meta">	'use strict'</span>;</span><br><span class="line">	<span class="keyword">switch</span> (target.nodeName.toLowerCase()) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Don't send a synthetic click to disabled inputs (issue #62)</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">'button'</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'select'</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'textarea'</span>:</span><br><span class="line">		<span class="keyword">if</span> (target.disabled) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'input'</span>:</span><br><span class="line"></span><br><span class="line">		<span class="comment">// File inputs need real clicks on iOS 6 due to a browser bug (issue #68)</span></span><br><span class="line">		<span class="keyword">if</span> ((deviceIsIOS &amp;&amp; target.type === <span class="string">'file'</span>) || target.disabled) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'label'</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="string">'video'</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//如是class中包含needsclick，刚返回true</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="regexp">/\bneedsclick\b/</span>).test(target.className);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>检测元素是否需要触发原生事件。如果在元素上加上 class样式needsclick，刚不会阻止默认事件。<br>如checkbox或者radio，select等，点击之后是需要触发原生事件的。<br>比如checkbox 点击之后，需要触发复选框勾上，并且点击label的时候也会触发checkbox的勾选事件。<br>如果没有在label上加上needclick的样式的话，那么fastclick只会模拟一个点击事件，而之后的触发checkbox的勾选事件，将会被阻止，那么为了避免这种情况，刚需要告诉fastclick,这里需要触发原生事件。</p>
<h3 id="onTouchStart-方法"><a href="#onTouchStart-方法" class="headerlink" title="onTouchStart 方法"></a>onTouchStart 方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * On touch start, record the position and scroll offset.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Event&#125; event</span><br><span class="line"> * @returns &#123;boolean&#125;</span><br><span class="line"> */</span><br><span class="line">FastClick.prototype.onTouchStart = function(event) &#123;</span><br><span class="line">	&apos;use strict&apos;;</span><br><span class="line">	var targetElement, touch, selection;</span><br><span class="line"></span><br><span class="line">	// Ignore multiple touches, otherwise pinch-to-zoom is prevented if both fingers are on the FastClick element (issue #111).</span><br><span class="line">	if (event.targetTouches.length &gt; 1) &#123;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	targetElement = this.getTargetElementFromEventTarget(event.target);</span><br><span class="line">	touch = event.targetTouches[0];</span><br><span class="line"></span><br><span class="line">	if (deviceIsIOS) &#123;</span><br><span class="line"></span><br><span class="line">		// Only trusted events will deselect text on iOS (issue #49)</span><br><span class="line">		selection = window.getSelection();</span><br><span class="line">		if (selection.rangeCount &amp;&amp; !selection.isCollapsed) &#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (!deviceIsIOS4) &#123;</span><br><span class="line"></span><br><span class="line">			// Weird things happen on iOS when an alert or confirm dialog is opened from a click event callback (issue #23):</span><br><span class="line">			// when the user next taps anywhere else on the page, new touchstart and touchend events are dispatched</span><br><span class="line">			// with the same identifier as the touch event that previously triggered the click that triggered the alert.</span><br><span class="line">			// Sadly, there is an issue on iOS 4 that causes some normal touch events to have the same identifier as an</span><br><span class="line">			// immediately preceeding touch event (issue #52), so this fix is unavailable on that platform.</span><br><span class="line">			// Issue 120: touch.identifier is 0 when Chrome dev tools &apos;Emulate touch events&apos; is set with an iOS device UA string,</span><br><span class="line">			// which causes all touch events to be ignored. As this block only applies to iOS, and iOS identifiers are always long,</span><br><span class="line">			// random integers, it&apos;s safe to to continue if the identifier is 0 here.</span><br><span class="line">			if (touch.identifier &amp;&amp; touch.identifier === this.lastTouchIdentifier) &#123;</span><br><span class="line">				event.preventDefault();</span><br><span class="line">				return false;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			this.lastTouchIdentifier = touch.identifier;</span><br><span class="line"></span><br><span class="line">			// If the target element is a child of a scrollable layer (using -webkit-overflow-scrolling: touch) and:</span><br><span class="line">			// 1) the user does a fling scroll on the scrollable layer</span><br><span class="line">			// 2) the user stops the fling scroll with another tap</span><br><span class="line">			// then the event.target of the last &apos;touchend&apos; event will be the element that was under the user&apos;s finger</span><br><span class="line">			// when the fling scroll was started, causing FastClick to send a click event to that layer - unless a check</span><br><span class="line">			// is made to ensure that a parent layer was not scrolled before sending a synthetic click (issue #42).</span><br><span class="line">			this.updateScrollParent(targetElement);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	this.trackingClick = true;</span><br><span class="line">	this.trackingClickStart = event.timeStamp;</span><br><span class="line">	this.targetElement = targetElement;</span><br><span class="line"></span><br><span class="line">	this.touchStartX = touch.pageX;</span><br><span class="line">	this.touchStartY = touch.pageY;</span><br><span class="line"></span><br><span class="line">	// Prevent phantom clicks on fast double-tap (issue #36)</span><br><span class="line">	if ((event.timeStamp - this.lastClickTime) &lt; this.tapDelay) &#123;</span><br><span class="line">		event.preventDefault();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return true;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>onTouchStart 回调方法，主要用来确定，用户第一次点击时，所点击的位置，已经所点击元素，完成初始化。</p>
<h3 id="onTouchEnd-方法"><a href="#onTouchEnd-方法" class="headerlink" title="onTouchEnd 方法"></a>onTouchEnd 方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * On touch end, determine whether to send a click event at once.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;Event&#125; event</span></span><br><span class="line"><span class="comment"> * @returns &#123;boolean&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FastClick.prototype.onTouchEnd = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line"><span class="meta">	'use strict'</span>;</span><br><span class="line">	<span class="keyword">var</span> forElement, trackingClickStart, targetTagName, scrollParent, touch, targetElement = <span class="keyword">this</span>.targetElement;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.trackingClick) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prevent phantom clicks on fast double-tap (issue #36)</span></span><br><span class="line">	<span class="keyword">if</span> ((event.timeStamp - <span class="keyword">this</span>.lastClickTime) &lt; <span class="keyword">this</span>.tapDelay) &#123;</span><br><span class="line">		<span class="keyword">this</span>.cancelNextClick = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reset to prevent wrong click cancel on input (issue #156).</span></span><br><span class="line">	<span class="keyword">this</span>.cancelNextClick = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.lastClickTime = event.timeStamp;</span><br><span class="line"></span><br><span class="line">	trackingClickStart = <span class="keyword">this</span>.trackingClickStart;</span><br><span class="line">	<span class="keyword">this</span>.trackingClick = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">this</span>.trackingClickStart = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// On some iOS devices, the targetElement supplied with the event is invalid if the layer</span></span><br><span class="line">	<span class="comment">// is performing a transition or scroll, and has to be re-detected manually. Note that</span></span><br><span class="line">	<span class="comment">// for this to function correctly, it must be called *after* the event target is checked!</span></span><br><span class="line">	<span class="comment">// See issue #57; also filed as rdar://13048589 .</span></span><br><span class="line">	<span class="keyword">if</span> (deviceIsIOSWithBadTarget) &#123;</span><br><span class="line">		touch = event.changedTouches[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// In certain cases arguments of elementFromPoint can be negative, so prevent setting targetElement to null</span></span><br><span class="line">		targetElement = <span class="built_in">document</span>.elementFromPoint(touch.pageX - <span class="built_in">window</span>.pageXOffset, touch.pageY - <span class="built_in">window</span>.pageYOffset) || targetElement;</span><br><span class="line">		targetElement.fastClickScrollParent = <span class="keyword">this</span>.targetElement.fastClickScrollParent;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	targetTagName = targetElement.tagName.toLowerCase();</span><br><span class="line">	<span class="keyword">if</span> (targetTagName === <span class="string">'label'</span>) &#123;</span><br><span class="line">		forElement = <span class="keyword">this</span>.findControl(targetElement);</span><br><span class="line">		<span class="keyword">if</span> (forElement) &#123;</span><br><span class="line">			<span class="keyword">this</span>.focus(targetElement);</span><br><span class="line">			<span class="keyword">if</span> (deviceIsAndroid) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			targetElement = forElement;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.needsFocus(targetElement)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Case 1: If the touch started a while ago (best guess is 100ms based on tests for issue #36) then focus will be triggered anyway. Return early and unset the target element reference so that the subsequent click will be allowed through.</span></span><br><span class="line">		<span class="comment">// Case 2: Without this exception for input elements tapped when the document is contained in an iframe, then any inputted text won't be visible even though the value attribute is updated as the user types (issue #37).</span></span><br><span class="line">		<span class="keyword">if</span> ((event.timeStamp - trackingClickStart) &gt; <span class="number">100</span> || (deviceIsIOS &amp;&amp; <span class="built_in">window</span>.top !== <span class="built_in">window</span> &amp;&amp; targetTagName === <span class="string">'input'</span>)) &#123;</span><br><span class="line">			<span class="keyword">this</span>.targetElement = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.focus(targetElement);</span><br><span class="line">		<span class="keyword">this</span>.sendClick(targetElement, event);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Select elements need the event to go through on iOS 4, otherwise the selector menu won't open.</span></span><br><span class="line">		<span class="comment">// Also this breaks opening selects when VoiceOver is active on iOS6, iOS7 (and possibly others)</span></span><br><span class="line">		<span class="keyword">if</span> (!deviceIsIOS || targetTagName !== <span class="string">'select'</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.targetElement = <span class="literal">null</span>;</span><br><span class="line">			event.preventDefault();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (deviceIsIOS &amp;&amp; !deviceIsIOS4) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don't send a synthetic click event if the target element is contained within a parent layer that was scrolled</span></span><br><span class="line">		<span class="comment">// and this tap is being used to stop the scrolling (usually initiated by a fling - issue #42).</span></span><br><span class="line">		scrollParent = targetElement.fastClickScrollParent;</span><br><span class="line">		<span class="keyword">if</span> (scrollParent &amp;&amp; scrollParent.fastClickLastScrollTop !== scrollParent.scrollTop) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Prevent the actual click from going though - unless the target node is marked as requiring</span></span><br><span class="line">	<span class="comment">// real clicks or if it is in the whitelist in which case only non-programmatic clicks are permitted.</span></span><br><span class="line">	<span class="comment">//如果不需要触发原生的事件，刚会直接阻止默认事件，然后采用touch事件模拟</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.needsClick(targetElement)) &#123;</span><br><span class="line">		event.preventDefault();</span><br><span class="line">		<span class="keyword">this</span>.sendClick(targetElement, event);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要完成以下事情：<br>1 如果两次点击在200MS以内，则直接阻止事件.<br>2 判定设备，已经是否需要focus等情况；<br>3 最后触发事件 sendClick;</p>
<h3 id="findControl-方法"><a href="#findControl-方法" class="headerlink" title="findControl 方法"></a>findControl 方法</h3><p>这里的findControl主要是用来找到lalbel等元素绑定的control元素。<br>如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span> =<span class="string">"test"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"test"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过上面的lable的for元素找到对应的 input 元素，如果是checkbox或者radio，则会触发对应的事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to find the labelled control for the given label element.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;EventTarget|HTMLLabelElement&#125; labelElement</span></span><br><span class="line"><span class="comment"> * @returns &#123;Element|null&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FastClick.prototype.findControl = <span class="function"><span class="keyword">function</span>(<span class="params">labelElement</span>) </span>&#123;</span><br><span class="line"><span class="meta">	'use strict'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fast path for newer browsers supporting the HTML5 control attribute</span></span><br><span class="line">	<span class="comment">// 如果直接获取到control属性，找到的话则直接赋值</span></span><br><span class="line">	<span class="keyword">if</span> (labelElement.control !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> labelElement.control;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// All browsers under test that support touch events also support the HTML5 htmlFor attribute</span></span><br><span class="line">	<span class="comment">//同上，如果找到for对应的值，那么可以直接使用getElementById，获取到元素.</span></span><br><span class="line">	<span class="keyword">if</span> (labelElement.htmlFor) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">document</span>.getElementById(labelElement.htmlFor);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If no for attribute exists, attempt to retrieve the first labellable descendant element</span></span><br><span class="line">	<span class="comment">// the list of which is defined here: http://www.w3.org/TR/html5/forms.html#category-label</span></span><br><span class="line">	<span class="comment">//如果没有for属性，那么直接获取第一个元素</span></span><br><span class="line">	<span class="keyword">return</span> labelElement.querySelector(<span class="string">'button, input:not([type=hidden]), keygen, meter, output, progress, select, textarea'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>尝试为label元素找到control(控制)节点。</p>
<h3 id="sendClick方法（核心方法）"><a href="#sendClick方法（核心方法）" class="headerlink" title="sendClick方法（核心方法）"></a>sendClick方法（核心方法）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Send a click event to the specified element.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;EventTarget|Element&#125; targetElement</span></span><br><span class="line"><span class="comment"> * @param &#123;Event&#125; event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FastClick.prototype.sendClick = <span class="function"><span class="keyword">function</span>(<span class="params">targetElement, event</span>) </span>&#123;</span><br><span class="line"><span class="meta">	'use strict'</span>;</span><br><span class="line">	<span class="keyword">var</span> clickEvent, touch;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// On some Android devices activeElement needs to be blurred otherwise the synthetic click will have no effect (#24)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.activeElement &amp;&amp; <span class="built_in">document</span>.activeElement !== targetElement) &#123;</span><br><span class="line">		<span class="built_in">document</span>.activeElement.blur();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	touch = event.changedTouches[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Synthesise a click event, with an extra attribute so it can be tracked</span></span><br><span class="line">	clickEvent = <span class="built_in">document</span>.createEvent(<span class="string">'MouseEvents'</span>);</span><br><span class="line">	clickEvent.initMouseEvent(<span class="keyword">this</span>.determineEventType(targetElement), <span class="literal">true</span>, <span class="literal">true</span>, <span class="built_in">window</span>, <span class="number">1</span>, touch.screenX, touch.screenY, touch.clientX, touch.clientY, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">	clickEvent.forwardedTouchEvent = <span class="literal">true</span>;</span><br><span class="line">	targetElement.dispatchEvent(clickEvent);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>根据用户touch的位置，合成鼠标事件，并触发。</p>
<p>以上基本上是fastclick的核心代码了，其实最重要的就是一个 sendClick方法，其它的都是在做一些额外的判断。</p>
<p>[ 后记 ]<br>这里我们在使用fastclick时，会出现一些问题，考虑下面的Html节点：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">lable</span> <span class="attr">for</span>=<span class="string">"test"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">id</span>=<span class="string">"test"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">span</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">	测试</span><br><span class="line"><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>正常而言，我们应该是点击label中的任何一个位置，都应该会触发checkbox的默认事件，但是在使用fastclick 时，点击span标签包裹的 “测试” 时，则不会触发checkbox的默认事件，这里主要是因为fastclick已经在模拟touch事件的时候，把默认默认事件阻止掉了，所以也就不会传播到事件到父级节点了。<br>但是当我们点击纯文本“测试”的事件，却可以完美的触发事件，这里主要是因为fastclick做了一个判断， 如果发现你点击的节点是文本节点，那么它把你当前点击的文本节点的父节点做为目标节点，然后并且触发focus事件，这样才能完美触发checkbox的默认事件，<br>注意的是，这里它只会找父节点，所以在label下的文本不能有再有嵌套的节点，如上面的span节点包含的”测试”元素的父节点只是一个span，所以无法触发focus事件。</p>
<p>而这个时候需要点击span包含的“测试”，并触发focus事件，那么只有两个方案：<br>1 给span节点添加class属性 “needsclick”,这时fastclick将不会采用touch去模拟事件，直接使用原生的事件，缺陷会是存在300MS延时。<br>2 修改源码<br>我想绝大的多数都会采用第一种方案，其实如果认真阅读一下源码，是可以修改一下源代码，根据需求去做一些判定的。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/18/about-event-detail/" rel="next" title="关于addEventListener绑定事件的一些细节">
                <i class="fa fa-chevron-left"></i> 关于addEventListener绑定事件的一些细节
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/08/mobile-input-problem/" rel="prev" title="移动端填坑">
                移动端填坑 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Kevin">
            
              <p class="site-author-name" itemprop="name">Kevin</p>
              <p class="site-description motion-element" itemprop="description">因上努力</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#needsClick-方法"><span class="nav-number">1.</span> <span class="nav-text">needsClick 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onTouchStart-方法"><span class="nav-number">2.</span> <span class="nav-text">onTouchStart 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onTouchEnd-方法"><span class="nav-number">3.</span> <span class="nav-text">onTouchEnd 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findControl-方法"><span class="nav-number">4.</span> <span class="nav-text">findControl 方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendClick方法（核心方法）"><span class="nav-number">5.</span> <span class="nav-text">sendClick方法（核心方法）</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
